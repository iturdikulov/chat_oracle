# ТЗ: Система «The Oracle of VODs»

**Продукт:** Веб-сервис для семантического поиска и автоматической нарезки клипов из Twitch VODs на основе анализа чата с помощью LLM.

---

## 1. Архитектура системы

Система строится на базе микросервисной архитектуры, развернутой в Docker-контейнерах.

* **Frontend:** Vue 3 (Vite, Pinia, Vuefity)
* **API Layer:** Flask (Python).
* **Database:** PostgreSQL + Pony ORM.
* **Vector Engine:** pgvector или ChromaDB.
* **Task Queue:** Celery + RabbitMQ.
* **State/Cache:** Redis.
* **Processing:** FFmpeg, OpenAI API (Embeddings & GPT-4).

---

## 2. Спецификация модулей

### 2.1. Модуль Индексации (Backend - Celery)

**Процесс:**

1. **Ingestion:** Получение ссылки на Twitch VOD.
2. **Chat Extraction:** Скачивание JSON-логов чата.
3. **Preprocessing:** * Очистка текста, замена смайлов (LUL -> *смех*).
* Разбивка на чанки (окна по 30-60 секунд) с перекрытием.


4. **Embedding:** Превращение текста чанка в вектор через `text-embedding-3-small`.
5. **Storage:** Сохранение в БД (Pony ORM) и вектора в векторное хранилище.

### 2.2. Модуль Поиска и LLM (Backend - Flask)

**Процесс:**

1. Прием текстового запроса от Vue (например, *"момент где он упал в лаву"*).
2. Векторизация запроса.
3. **Semantic Search:** Поиск топ-N наиболее похожих чанков в БД.
4. **RAG Refinement:** Отправка текста найденных чанков в GPT-4o для уточнения таймкода и выбора "самого сочного" момента.

### 2.3. Модуль Видео-рендеринга (Backend - Celery + FFmpeg)

**Процесс:**

1. Вырезка фрагмента видео из VOD.
2. Наложение оверлея чата (рендеринг текста поверх видео).
3. Опциональный кроп (9:16) для мобильных форматов.
4. Сохранение в `/media` и уведомление фронтенда через Redis.

### 2.4. Frontend (Vue.js 3)

**Ключевые страницы и компоненты:**

* **Dashboard:** Список добавленных стримов, прогресс-бары обработки (через polling API).
* **Search Console:** Чат-интерфейс для ввода запросов "Оракулу".
* **Player:** Интеграция видео с интерактивной «тепловой картой» (Heatmap), отражающей активность чата.
* **Result Gallery:** Сетка сгенерированных клипов с кнопками "Download" и "Share".

---

## 3. Схема данных (Pony ORM)

```python
from pony.orm import *

db = Database()

class Stream(db.Entity):
    twitch_id = Required(str, unique=True)
    title = Required(str)
    status = Required(str)  # 'processing', 'ready', 'error'
    segments = Set('ChatSegment')
    clips = Set('Clip')

class ChatSegment(db.Entity):
    stream = Required(Stream)
    start_ts = Required(int)
    end_ts = Required(int)
    text_content = Required(LongStr)
    vector_id = Optional(str)  # Ссылка на векторный индекс

class Clip(db.Entity):
    stream = Required(Stream)
    video_path = Required(str)
    description = Optional(str)

```

---

## 4. API Эндпоинты

| Метод | Путь | Описание |
| --- | --- | --- |
| `POST` | `/api/v1/streams` | Добавить новый VOD на индексацию |
| `GET` | `/api/v1/streams` | Список всех проиндексированных VOD |
| `GET` | `/api/v1/status/<task_id>` | Получить статус Celery-задачи (процент) |
| `POST` | `/api/v1/search` | Семантический поиск моментов |
| `POST` | `/api/v1/render` | Запуск генерации MP4 клипа |

---

## 5. Инфраструктура и Развертывание

1. **Контейнеризация:** Весь стек описывается в `docker-compose.yml`.
2. **Reverse Proxy:** Nginx управляет доступом к API и раздает статические файлы видео.
3. **CI/CD:** GitHub Actions выполняет сборку образов и деплой на Linux-сервер.

---

## 6. План реализации (Roadmap)

1. **Phase 1 (MVP):** Flask + Pony ORM + Парсинг чата. Базовый поиск по ключевым словам.
2. **Phase 2 (AI):** Интеграция Embeddings и векторного поиска. Реализация логики "Оракула".
3. **Phase 3 (Video):** Celery-воркеры с FFmpeg. Генерация простых отрывков.
4. **Phase 4 (UI):** Vue.js интерфейс, Pinia для трекинга задач, визуализация Heatmap.

## Задачи на потом - Аналитика

### Чат

Общее состояние потока и сообщества.

Разбейте чат на временные интервалы (например, на 30 секунд или 1 минуту).
Измерьте объем сообщений, настроение, использование эмоций в каждом окне.
Выявлять повторяющиеся закономерности (например, ажиотаж в начале, затишье в середине, всплеск в кульминационный момент).
Навыки: Анализ временных рядов, оконные функции в SQL, визуализация.

### Тематическое моделирование

О чем говорят зрители в разных сегментах.

Используйте методы NLP, такие как LDA или используйте BERTopic в текстовом чате.
Сопоставьте темы с временными метками.
Сравните изменения тем в стримах или играх.
Навыки: НЛП, кластеризация, размерность сокращение.

### Профилирование поведения пользователей

Различные типы участников чата.

Группируйте пользователей по активности (скрытники, случайные собеседники, спамеры, влиятельные пользователей).
Отслеживайте, как меняется вовлеченность пользователей в разных потоках.
Создавайте информационные панели, отображающие распределение типов пользователей.
Навыки: Кластеризация, сегментация пользователей, поведенческая аналитика.

### Обнаружение всплесков эмоций

Внезапные всплески определенных эмоций (например, PogChamp).

Отслеживание частоты появления каждой эмоции с течением времени.
Обнаружить выборки с использованием статистических пороговых значений.
Сопоставляйте выборки с видеособытиями (убийствами, голами, шутками).
Навыки: Обнаружение событий, аномалий., визуализация.

### Сравнительный анализ кросс‑стримов

Чем отличается чат между стримерами или играми.

Сравните среднее количество настроений, использование эмоций, количество сообщений длина.
Определите уникальные “подписи в чате” для каждого стримера.
Составьте рейтинг сходства между сообществами.
Навыки: Сравнительная статистика, сходство показатели, информационные панели.

### Тенденции модерации и токсичности

Что нужно проанализировать: как модерация взаимодействует с потоком общения в чате.

Выявляйте токсичные выражения с помощью классификаторы.
Сравните события модерации с токсичные всплески.
Изучите эффективность стратегий модерации.
Навыки: классификация НЛП, этика работы с данными, корреляционный анализ.

### Прогнозирование Моделирование

Что нужно проанализировать: Может ли чат предсказывать будущие события?

Обучите модели предсказывать моменты ажиотажа, основываясь на особенностях чата.
Предсказывайте действия стримеров (например, крупные проекты) из групповых чатов.
Навыки: Машинное обучение, разработка функциональных возможностей, обучение под наблюдением.
